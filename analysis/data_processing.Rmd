---
title: "Spin-within"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)

library(tidyverse)
library(ggthemes)
library(jsonlite)
library(readxl)
library(tidyboot)
library(GGally)


```

# Comprehension

```{r}

# get data:

# rsync -zaP manuelb@ccp-odc.eva.mpg.de:/srv/ccp-odc/manuel_bohn/spin-within/data/  ~/Work/Local/Spin-within/raw_data/

files <- dir("~/Work/Local/Spin-within/raw_data", pattern = ".json")

raw_data <- tibble()
for (f in files) {
  jf <- paste("~/Work/Local/Spin-within/raw_data/",f,sep="")
  jd <- jsonlite::fromJSON(paste(readLines(jf), collapse=""))
  date <- str_sub(jf,47,str_length(jf)-11)
  id <- as_tibble(jd$data$data) %>% mutate(test_date = date,
                                              trial = as.character(trial))
  raw_data <- bind_rows(raw_data, id)
}

log_id <- read_excel("../../../../Cloud/spin-within/spin-within_subject_list.xlsx")%>%
  mutate(birthday = as.Date(birthday, format = "%d.%m.%Y"),
         test_day_1 = as.Date(test_day_1, format = "%d.%m.%Y"),
         test_day_2 = as.Date(test_day_2, format = "%d.%m.%Y"),
         age_num = as.numeric(difftime(test_day_1, birthday, units = "days"))/365.25)%>%
  rename(subid = ID,
         subage = age,
         age = age_num)%>%
  select(subid, subage,age, status)

log_prod <- read_excel("../../../../Cloud/spin-within/vocab_codingsheet.xlsx")%>%
  filter(task == "production")%>%
  rename(subid = ID,
         familiar = object,
         correct = performance)%>%
  mutate(subid = as.character(subid))

# add filtering of invalid trials

data <-  raw_data%>%
  mutate(subage = ifelse(subage == "4 ", "4", subage),
         familiar = ifelse(task == "comprehension", target, familiar))%>%
  left_join(log_id)%>%
  bind_rows(log_prod%>%left_join(log_id))%>%
  filter(status == "keep", 
         !grepl("train",trial))%>%
  select(-target)%>%
  mutate(age = age - min(age))

write_csv(data,"../data/merged_data.csv")

# FÃ¼r Louisa ab hier: 
data <- read_csv("../data/merged_data.csv")%>%
  arrange(test_date)%>%
  mutate(subage = factor(subage))

#write(toJSON(data), file = "../data//merged_data.json")

```

# Sample
```{r}
data%>%
  group_by(subid)%>%
  summarise(me = sum(task == "mutual_exclusivity"),
            novelty = sum(task == "novelty"),
            combination = sum(task == "combination"),
            comp = sum(task == "comprehension"),
            prod = sum(task == "production"))

```
# Single tasks

```{r}
p1 <- data %>%
  filter(task != "combination")%>%
  group_by(subage,task, subid) %>%
  filter(!grepl("train",trial)) %>%
  summarise(mean = mean(correct))

p2 <- p1 %>%
  group_by(subage,task) %>%
  tidyboot_mean(column = mean)%>%
  mutate(chance = ifelse(task == "mutual_exclusivity" | task == "novelty", 1/2, NA))

ggplot()+
  geom_hline(data = p2, aes(yintercept =chance), lty = 2, alpha = .5)+
  #geom_smooth(data = p1, aes(x = subage, y = mean), method = "lm", col = "black", size = 1)+
  geom_jitter(data = p1, aes(x = subage, y = mean), alpha = .5, width = .05, height = .01)+
  geom_pointrange(data = p2, aes(x = subage, y = mean, ymin = ci_lower, ymax = ci_upper, col = subage), position = position_dodge(width = .5))+
  facet_grid(~task)+
  labs(x = "Age Group", y = "Proportion Correct") +
  scale_color_ptol(name = "Age") +
  ylim(-0.05, 1.05)+
  theme_few()
```
# Correlations between tasks requiring semantic knowledge 

```{r}
cor <- data %>% 
  filter(task == "mutual_exclusivity" | task == "comprehension" | task == "production")%>%
  group_by(subid,subage, task)%>%
  summarise(mean = mean(correct))%>%
  pivot_wider(names_from = "task", values_from = "mean")%>%
  ungroup()

ggpairs(cor, columns =3:5)+
  theme_few()+
  scale_colour_ptol()
```


# combination

```{r}
pc <- data %>%
  filter(task == "combination")%>%
  filter(!grepl("train",trial)) %>%
  group_by(subage,task,condition) %>%
  tidyboot_mean(column = correct)


ggplot()+
  #geom_hline(yintercept = 0.5, lty = 2, alpha = .5)+
  #geom_smooth(data = p1, aes(x = subage, y = mean), method = "lm", col = "black", size = 1)+
  #geom_jitter(data = pc, aes(x = subage, y = mean), alpha = .5, width = .05, height = .01)+
  geom_pointrange(data = pc, aes(x = subage, y = mean, ymin = ci_lower, ymax = ci_upper, col = condition), position = position_dodge(width = .5))+
  #facet_grid(condition~.)+
  labs(x = "Age Group", y = "Proportion unfamiliar object chosen") +
  scale_color_colorblind(name = "Condition") +
  ylim(-0.05, 1.05)+
  theme_few()
```



```{r}
data %>%
  filter(subid == 65507,
         task == "production")%>%
  select(task, familiar, correct)

unique(data$familiar)
```

